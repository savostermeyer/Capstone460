<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SkinAI Classifier ‚Äî Upload</title>

  <link rel="stylesheet" href="styles/styles.css" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">

  <style>
    /* Additional form styling */
    .q-grid{ display:grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 12px; }
    .q-card{ background:#111; border:1px solid #2a2a2a; border-radius:12px; padding:14px; box-shadow: var(--shadow); }
    .q-label{ display:block; font-weight:700; margin-bottom:8px; }
    .q-hint{ margin:6px 0 0; font-size:.85rem; color:var(--muted); }
    .q-input,.q-select,.q-textarea{
      width:100%; padding:10px 12px; border-radius:10px; border:1px solid #2a2a2a; background:#0f0f0f; color:var(--text);
    }
    .q-textarea{ min-height:110px; resize:vertical; }
    .section-sub{ margin:-6px 0 14px; color:var(--muted); }
    .form-actions{
      position:sticky; bottom:0; background: linear-gradient(180deg, rgba(10,10,10,.1), var(--bg));
      padding:10px 0 0; margin-top: 6px; display:flex; gap:10px; align-items:center;
    }
    .pill{ display:inline-block; padding:6px 10px; border-radius:999px; border:1px solid #2a2a2a; background:#111; margin: 2px 6px 0 0; font-size:.85rem; }
    .result{ display:none; } .result.show{ display:block; }
    .req{ color: var(--gold); margin-left: 4px; }
    .dropzone{ outline-offset:4px; cursor:pointer; }
    .preview img{ width:100%; height:220px; object-fit:cover; border-radius:12px; border:1px solid #2a2a2a; }
  </style>
</head>

<body>
  <!-- Header -->
  <header class="site-header" role="banner">
    <div class="container header-inner">
      <a class="brand" href="index.html">
        <div class="brand-mark">AI</div>
        <div class="brand-text">
          <strong>SkinAI Classifier</strong>
          <span>Purdue University</span>
        </div>
      </a>

      <nav class="nav">
        <a href="index.html" class="nav-link">Home</a>
        <a href="upload.html" class="nav-link">Upload</a>
        <a href="reports.html" class="nav-link">Reports</a>
        <a href="team.html" class="nav-link">About Us</a>
        <a href="login.html" class="nav-link">Login</a>
      </nav>
    </div>
  </header>

  <!-- Main -->
  <main class="container narrow">
    <section class="section-pad">
      <h1 class="h-title">Upload</h1>
      <p class="muted">Drag and drop JPG/PNG files or click to browse.</p>

      <!-- DROPZONE -->
      <div id="dz" class="dropzone card" tabindex="0" aria-label="Image upload area" 
           style="padding:28px; text-align:center;">
        <div style="font-size:2rem;">‚¨ÜÔ∏è</div>
        <p class="dz-title" style="font-weight:700; margin-top:8px;">Drag & drop your images here</p>
        <p class="dz-sub" style="color:var(--muted)">or click to browse</p>

        <label class="file-btn" style="margin-top:10px;">
          Choose File
          <input id="fileInput" type="file" accept="image/jpeg,image/png" multiple />
        </label>

        <p class="q-hint">Tip: Upload multiple images for comparison.</p>
      </div>

      <!-- MULTI-PREVIEW GRID -->
      <div id="preview" class="preview" 
           style="margin-top:16px; display:grid; gap:12px; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));">
      </div>

      <!-- FORM -->
      <form id="intakeForm" class="card">
        <h2 class="h-title" style="font-size:1.25rem;">Patient Intake</h2>
        <p class="section-sub">Required fields marked with <span class="req">*</span></p>

        <div class="q-grid">
          <div class="q-card">
            <label class="q-label">Full Name <span class="req">*</span></label>
            <input class="q-input" id="name" required />
          </div>

          <div class="q-card">
            <label class="q-label">Age <span class="req">*</span></label>
            <input class="q-input" id="age" type="number" min="0" max="120" required />
          </div>

          <div class="q-card">
            <label class="q-label">Sex at Birth</label>
            <select class="q-select" id="sex">
              <option value="">Prefer not to say</option>
              <option>Female</option>
              <option>Male</option>
              <option>Intersex</option>
            </select>
          </div>

          <div class="q-card">
            <label class="q-label">Skin Condition <span class="req">*</span></label>
            <select class="q-select" id="skinType" required>
              <option value="">Select...</option>
              <option value="I">I ‚Äî Very fair</option>
              <option value="II">II ‚Äî Fair</option>
              <option value="III">III ‚Äî Medium</option>
              <option value="IV">IV ‚Äî Olive</option>
              <option value="V">V ‚Äî Brown</option>
              <option value="VI">VI ‚Äî Dark brown</option>
            </select>
          </div>

          <div class="q-card">
            <label class="q-label">Location <span class="req">*</span></label>
            <input class="q-input" id="location" required />
          </div>

          <div class="q-card">
            <label class="q-label">Duration (days) <span class="req">*</span></label>
            <input class="q-input" id="duration" type="number" min="0" max="3650" required />
          </div>

          <div class="q-card" style="grid-column:1/-1;">
            <label>
              <input id="consent" type="checkbox" /> I confirm this image is mine and consent to analysis. <span class="req">*</span>
            </label>
          </div>
        </div>

        <div class="form-actions">
          <button id="analyzeBtn" class="btn btn-cta" type="submit" disabled>Analyze</button>
          <button type="button" id="clearBtn" class="btn btn-secondary">Clear</button>
          <span id="formMsg" class="q-hint"></span>
        </div>
      </form>

      <!-- RESULTS -->
      <div id="resultCard" class="card result">
        <h3>Preliminary Analysis (demo)</h3>
        <p id="resultMeta" class="muted"></p>
        <div id="resultTags" style="margin-top:6px;"></div>
      </div>
    </section>
  </main>

  <!-- FOOTER -->
  <footer class="site-footer">
    <div class="container">
      <p class="footnote">¬© <span id="year"></span> SkinAI Classifier</p>
    </div>
  </footer>

  <script>
  // Footer year
  document.getElementById('year').textContent = new Date().getFullYear();

  /* --- Upload + preview --- */
  const dz = document.getElementById('dz');
  const fileInput = document.getElementById('fileInput');
  const preview = document.getElementById('preview');
  let selectedFile = null;

  const prevent = e => { e.preventDefault(); e.stopPropagation(); };
  ['dragenter','dragover','dragleave','drop'].forEach(evt => dz.addEventListener(evt, prevent));
  dz.addEventListener('dragover', () => dz.style.outline = '2px solid var(--gold)');
  dz.addEventListener('dragleave', () => dz.style.outline = '');
  dz.addEventListener('drop', (e) => {
    dz.style.outline = '';
    const f = e.dataTransfer.files && e.dataTransfer.files[0];
    if (f) handleFile(f);
  });
  dz.addEventListener('click', () => fileInput.click());
  fileInput.addEventListener('change', (e) => {
    const f = e.target.files && e.target.files[0];
    if (f) handleFile(f);
  });

  function handleFile(file){
    if(!/image\/(jpeg|png)/.test(file.type)){
      alert('Please upload a JPG or PNG.');
      return;
    }
    selectedFile = file;
    const url = URL.createObjectURL(file);
    preview.innerHTML = '';
    const img = document.createElement('img');
    img.src = url;
    img.alt = 'Uploaded image preview';
    preview.appendChild(img);
    validateForm();
  }

  /* --- Form validation --- */
  const form = document.getElementById('intakeForm');
  const analyzeBtn = document.getElementById('analyzeBtn');
  const clearBtn = document.getElementById('clearBtn');
  const consent = document.getElementById('consent');
  const formMsg = document.getElementById('formMsg');

  function validateForm(){
    const requiredIds = ['name','age','skinType','location','duration'];
    const allFilled = requiredIds.every(id => document.getElementById(id).value.trim() !== '');
    const ok = !!selectedFile && consent.checked && allFilled;
    analyzeBtn.disabled = !ok;
    formMsg.textContent = ok ? '' : 'Upload an image, fill required fields, and give consent.';
  }

  form.addEventListener('input', validateForm);
  form.addEventListener('change', validateForm);

  /* --- Submit to backend --- */
  form.addEventListener('submit', (e) => {
    e.preventDefault();
    if (analyzeBtn.disabled) return;

    const data = {
      name: document.getElementById('name').value.trim(),
      age: +document.getElementById('age').value,
      sex: document.getElementById('sex').value,
      fitzpatrick: document.getElementById('skinType').value,
      location: document.getElementById('location').value.trim(),
      duration_days: +document.getElementById('duration').value,
      symptom: document.getElementById('symptom').value,
      family_history: document.getElementById('background').value,
      sun_exposure: document.getElementById('sunExp').value,
      spf: document.getElementById('spf').value,
      meds: document.getElementById('meds').value.trim(),
      notes: document.getElementById('notes').value.trim(),
    };

    const tags = document.getElementById('resultTags');
    tags.innerHTML = '';

    [
      data.sex && `Sex: ${data.sex}`,
      data.symptom && `Symptom: ${data.symptom}`,
      data.family_history && `Family hx: ${data.family_history}`,
      data.sun_exposure && `Sun exposure: ${data.sun_exposure}`,
      data.spf && `SPF: ${data.spf}`,
      data.meds && `Meds: ${data.meds}`
    ]
    .filter(Boolean)
    .forEach(t => {
      const pill = document.createElement('span');
      pill.className = 'pill';
      pill.textContent = t;
      tags.appendChild(pill);
    });

    document.getElementById('resultCard').classList.add('show');

    const formData = new FormData();
    formData.append('image', selectedFile);

    Object.entries(data).forEach(([k,v]) => formData.append(k,v));

    formMsg.textContent = "Analyzing image...";
    analyzeBtn.disabled = true;

    fetch('http://127.0.0.1:3720/chat', {
      method: 'POST',
      body: formData
    })
    .then(res => res.json())
    .then(json => {
      console.log("Server response:", json);
      formMsg.textContent = "Analysis complete!";
      analyzeBtn.disabled = false;

      document.getElementById('resultMeta').textContent =
        `${data.name || 'Patient'}, age ${data.age} ‚Äî ${json.reply || 'AI processed successfully.'}`;

      tags.innerHTML = '';

      if (json.results && Array.isArray(json.results)){
        json.results.forEach(r => {
          const pill = document.createElement('span');
          pill.className = 'pill';
          pill.textContent = r.label || r.prediction || JSON.stringify(r);
          tags.appendChild(pill);
        });
      }
    })
    .catch(err => {
      console.error(err);
      formMsg.textContent ="Error connecting to backend.";
      analyzeBtn.disabled = false;
    });
  });

  clearBtn.addEventListener('click', () => {
    form.reset();
    preview.innerHTML = '';
    selectedFile = null;
    document.getElementById('resultCard').classList.remove('show');
    validateForm();
  });
</script>


<!-- Floating Chatbot Widget -->
<div id="chatbot-widget">
  <div id="chatbot-button">
    <span class="chat-icon">üí¨</span>
    <span class="chat-label">Talk to AI Agent</span>
  </div>

  function validateForm() {
    const required = ["name","age","skinType","location","duration"];
    const ok = required.every(id => document.getElementById(id).value.trim() !== "")
              && consent.checked
              && selectedFiles.length > 0;

    analyzeBtn.disabled = !ok;
  }

  document.getElementById("intakeForm").addEventListener("input", validateForm);
  document.getElementById("intakeForm").addEventListener("change", validateForm);

  /* ---------- CLEAR BUTTON ---------- */
  document.getElementById("clearBtn").onclick = () => {
    selectedFiles = [];
    preview.innerHTML = "";
    document.getElementById("intakeForm").reset();
    analyzeBtn.disabled = true;
  };
</script>


  <!-- CHATBOT -->
  <div id="chatbot-widget">
    <div id="chatbot-button">
      <span class="chat-icon">üí¨</span>
      <span class="chat-label">Talk to AI Agent</span>
    </div>

    <div id="chatbot-window">
      <div id="chatbot-header">
        <span>Talk to AI Agent</span>
        <button id="chatbot-close">‚úï</button>
      </div>

      <div id="chatbot-messages"></div>

      <div id="chatbot-input-area">
        <input id="chatbot-input" type="text" placeholder="Type your message‚Ä¶" />
        <button id="chatbot-send">‚û§</button>
      </div>
    </div>
  </div>

  <script src="scripts/chatbot.js"></script>
</body>
</html>
