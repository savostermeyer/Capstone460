<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SkinAI Classifier â€” Reports</title>

  <!-- Match your project path -->
  <link rel="stylesheet" href="styles/styles.css" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
</head>
<body>
  <!-- Header / Nav -->
  <header class="site-header" role="banner">
    <div class="container header-inner">
      <a class="brand" href="index.html" aria-label="SkinAI Classifier Home">
        <div class="brand-mark" aria-hidden="true">AI</div>
        <div class="brand-text">
          <strong>SkinAI Classifier</strong>
          <span>Purdue University</span>
        </div>
      </a>
     <nav class="nav" aria-label="Primary">
  <a href="index.html" class="nav-link">Home</a>
  <a href="upload.html" class="nav-link">Upload</a>
  <a href="reports.html" class="nav-link">Reports</a>
  <a href="team.html" class="nav-link">About Us</a>
  <a href="login.html" class="nav-link">Login</a>
</nav>

    </div>
  </header>

  <!-- Main -->
  <main class="container">
    <section class="section-pad" aria-labelledby="reports-title">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap">
        <h1 id="reports-title" class="h-title" style="margin:0">Reports</h1>
        <div>
          <span id="hello" class="muted"></span>
          <button id="signout" class="btn" style="margin-left:8px">Sign out</button>
        </div>
      </div>
      <p class="muted" style="margin-top:8px">Your saved analysis results are shown below.</p>

      <!-- Empty state -->
      <div id="empty" class="card" style="display:none">
        <p>No reports yet. Try <a href="upload.html">uploading an image</a> to generate your first report.</p>
      </div>

      <!-- Reports list -->
      <div id="report-list" style="display:grid;gap:12px"></div>
    </section>
  </main>

  <!-- Footer -->
  <footer class="site-footer" role="contentinfo">
    <div class="container">
      <p class="footnote">Â© <span id="year"></span> SkinAI Classifier Â· Senior Capstone Project Â· For demonstration only.</p>
    </div>
  </footer>

  <script>
    // --------- Simple auth gate ----------
    const yearEl = document.getElementById('year');
    yearEl.textContent = new Date().getFullYear();

    // If you haven't already, add this ONE line in login.html before redirecting:
    // localStorage.setItem('skinai_user', email.value);

    const userEmail = localStorage.getItem('skinai_user');
    const nextParam = encodeURIComponent('reports.html');
    if (!userEmail) {
      // not logged in â†’ go to login, then back to reports after
      window.location.href = `login.html?next=${nextParam}`;
    }

    document.getElementById('hello').textContent = userEmail ? `Signed in as ${userEmail}` : '';

    document.getElementById('signout').addEventListener('click', () => {
      localStorage.removeItem('skinai_user');
      window.location.href = 'login.html';
    });

    // --------- Demo data storage ----------
    // Each user's reports are stored in localStorage under:
    //  key: skinai_reports_<email>  value: JSON.stringify([...])
    function getUserReports(email) {
      const raw = localStorage.getItem(`skinai_reports_${email}`);
      return raw ? JSON.parse(raw) : [];
    }
    function setUserReports(email, data) {
      localStorage.setItem(`skinai_reports_${email}`, JSON.stringify(data));
    }

    // If no reports yet, seed with a sample so the page isn't empty
    (function seedIfEmpty(){
      const current = getUserReports(userEmail);
      if (current.length === 0) {
        const sample = [
          {
            id: crypto.randomUUID(),
            createdAt: new Date().toISOString(),
            filename: "lesion_2025-10-10_14-32-11.jpg",
            topPredictions: [
              { label: "Melanocytic nevus", confidence: 0.78 },
              { label: "Benign keratosis", confidence: 0.15 },
              { label: "Melanoma (flag for review)", confidence: 0.07 }
            ],
            notes: "Preliminary model output. Not a medical diagnosis."
          }
        ];
        setUserReports(userEmail, sample);
      }
    })();

    // --------- Render reports ----------
    const listEl = document.getElementById('report-list');
    const emptyEl = document.getElementById('empty');

    function fmtPct(x){ return (x*100).toFixed(1) + '%'; }
    function fmtDate(iso){
      const d = new Date(iso);
      return d.toLocaleString([], {year:'numeric', month:'short', day:'2-digit', hour:'2-digit', minute:'2-digit'});
    }

    function render() {
      const reports = getUserReports(userEmail);
      listEl.innerHTML = '';
      if (!reports.length) {
        emptyEl.style.display = 'block';
        return;
      }
      emptyEl.style.display = 'none';

      for (const r of reports) {
        const card = document.createElement('div');
        card.className = 'card';
        card.innerHTML = `
          <div style="display:flex;justify-content:space-between;gap:12px;flex-wrap:wrap">
            <div>
              <h3 style="margin:0 0 4px 0">${r.filename}</h3>
              <div class="muted">Created: ${fmtDate(r.createdAt)}</div>
            </div>
            <div>
              <a class="btn" href="upload.html">Analyze another</a>
            </div>
          </div>

          <div style="margin-top:10px">
            <strong>Top predictions</strong>
            <ul style="margin:6px 0 0 18px">
              ${r.topPredictions.map(p => `<li>${p.label} â€” ${fmtPct(p.confidence)}</li>`).join('')}
            </ul>
            <p class="muted" style="margin-top:8px">${r.notes || ''}</p>
          </div>

          <div style="display:flex;gap:8px;margin-top:12px;flex-wrap:wrap">
            <button class="btn" data-action="download" data-id="${r.id}">Download JSON</button>
            <button class="btn" data-action="delete" data-id="${r.id}">Delete</button>
          </div>
        `;
        listEl.appendChild(card);
      }
    }

    // Download / Delete handlers
    listEl.addEventListener('click', (e) => {
      const btn = e.target.closest('button[data-action]');
      if (!btn) return;

      const action = btn.getAttribute('data-action');
      const id = btn.getAttribute('data-id');
      const reports = getUserReports(userEmail);
      const idx = reports.findIndex(r => r.id === id);
      if (idx === -1) return;

      if (action === 'download') {
        const blob = new Blob([JSON.stringify(reports[idx], null, 2)], {type:'application/json'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `skinai_report_${id}.json`;
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
      } else if (action === 'delete') {
        reports.splice(idx, 1);
        setUserReports(userEmail, reports);
        render();
      }
    });

    render();
  </script>

<!-- Floating Chatbot Widget -->
<div id="chatbot-widget">
  <div id="chatbot-button">
    <span class="chat-icon">ðŸ’¬</span>
    <span class="chat-label">Talk to AI Agent</span>
  </div>

  <div id="chatbot-window">
    <div id="chatbot-header">
      <span>Talk to AI Agent</span>
      <button id="chatbot-close">âœ•</button>
    </div>

    <div id="chatbot-messages"></div>

    <div id="chatbot-input-area">
      <input id="chatbot-input" type="text" placeholder="Type your messageâ€¦" />
      <button id="chatbot-send">âž¤</button>
    </div>
  </div>
</div>



<script src="scripts/chatbot.js"></script>

</body>
</html>
